# PSPNet_Image_Segmentation

一个基于PSPNet金字塔场景解析网络的图像语义分割处理方法

An image semantic segmentation processing method based on PSPNet

## 注意事项

model_data下面存有.h5文件

### 1 环境配置问题

#### 1.1 代码运行所用环境

**TensorFlow版本为2.2.0及以上，无需安装keras（TF2自带），深度学习环境配置的博客地址为：**
<https://blog.csdn.net/weixin_44791964/article/details/109161493>

#### 1.2 关于30系列显卡的环境配置

30系显卡由于框架更新不可使用上述环境配置教程。本人已经测试可用的30系显卡配置如下：

**Tensorflow版本为2.4.0及以上（2.8.0可用），cuda版本为11.0.2，cudnn版本为8.0.5。**

一般cuda安装前需要安装Visual Studio

#### 1.3 需要提前安装的库

tensorflow，numpy，matplotlib，PIL，cv2，tqdm等

### 2 训练相关问题

#### 2.1 shape不匹配问题

运行predict.py若提示shape不匹配，请检查train.py以及predict.py文件里num_classes是否修改为与数据集相对应的类别数目。

#### 2.2 显存问题

若运行train.py下面时，报错提示OOM，说明显存溢出了，需要改小batch_size。
**需要注意的是，受到BatchNorm2d影响，batch_size不可为1，至少为2。**

#### 2.3 冻结训练与解冻训练

本项目运用了迁移学习的思想，由于神经网络主干特征提取部分所提取到的特征是通用的，因此在训练时冻结主干部分可以加快训练效率，也可以防止权值被破坏。
**在冻结阶段，模型的主干被冻结了，特征提取网络不发生改变。占用的显存较小，仅对网络进行微调。**
**在解冻阶段，模型的主干不被冻结了，特征提取网络会发生改变。占用的显存较大，网络所有的参数都会发生改变。**

#### 2.4 模型识别小目标能力不佳问题

可以修改下采样倍率downsample_factor，当downsample_factor为16的时候下采样倍数过大，会导致特征图层丢失过多信息，导致效果不太好，在显存充足的条件下可以修改其值为8。

#### 2.5 预训练权重问题

首先不建议模型从零开始训练。模型特征提取能力在随机初始化参数的情况下非常差，没有好的参数调节能力和算力，无法使得网络正常收敛，无法有效提取特征。
如果一定要从零开始训练，那么训练时不载入预训练权重，同时不执行冻结训练模型部分。

**网络训练一般需要载入预训练权重，将model_path修改成预训练模型权值的路径。数据的预训练权重对不同数据集一般来说是通用的，因为同类物体的特征是通用的。**

如果想使用断点续练，需要同预训练权重一样的方式载入已经训练了几个epochs的模型（保存在logs文件夹中）
